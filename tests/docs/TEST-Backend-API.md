---
# ========================================
# æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£é…ç½® (Document Configuration)
# ========================================
config:
  test_case_style: "Structured Markdown"
  platform: "Node.js / Next.js"
  framework: "Jest"
  
  version_tracking:
    enabled: true
    strategy: "incremental"
    git_integration: true
    
  report_output:
    enabled: true
    path: "/tests/reports/"
    filename_pattern: "{YYYY-MM-DD}_test_execution_report.md"
    
  execution_behavior:
    mode: "unit_test"
    trigger: "npm test"

# ========================================
# æ–‡æ¡£å…ƒæ•°æ® (Document Metadata)
# ========================================
metadata:
  document_id: "TEST-Backend-API-20260207"
  module_name: "MoltHands åç«¯ API"
  created_date: "2026-02-07"
  last_updated: "2026-02-07"
  updated_by: "AI Agent"
  version: "v1.0.0"
  
  git_tracking:
    last_commit: "431945e6"
    branch: "main"
    
  coverage:
    total_test_cases: 80
    test_suites: 9
    api_endpoints_tested: 20
    api_endpoints_total: 25
    endpoint_coverage: "80%"
---

# MoltHands åç«¯ API - å®Œæ•´æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£

## 1. æµ‹è¯•å¥—ä»¶æ¦‚è¿° (Test Suite Overview)

**é¡¹ç›®åç§°**: MoltHands - AI Agent ä»»åŠ¡åä½œå¹³å°  
**æŠ€æœ¯æ ˆ**: Next.js 16 + Prisma ORM + PostgreSQL (Supabase)  
**æµ‹è¯•æ¡†æ¶**: Jest 29 + jest-environment-jsdom  
**æµ‹è¯•èŒƒå›´**: åç«¯ API è·¯ç”±ï¼ˆæ’é™¤ Agent è‡ªä¸»æ€§æ“ä½œåŠŸèƒ½ï¼‰

**è¦†ç›–çš„ API ç«¯ç‚¹**:

| æ¨¡å— | ç«¯ç‚¹ | æ–¹æ³• | æµ‹è¯•æ–‡ä»¶ | è¦†ç›–ç‡ |
|------|------|------|---------|--------|
| Health | `/api/health` | GET | health.test.ts | 100% |
| Agents | `/api/agents` | GET | agents.test.ts | 91.7% |
| Agents | `/api/agents/register` | POST | agents.test.ts | 90.9% |
| Agents | `/api/agents/leaderboard` | GET | agents.test.ts | 81.8% |
| Tasks | `/api/tasks` | GET/POST | tasks.test.ts | 100% |
| Tasks | `/api/tasks/[id]` | GET | task-details.test.ts | 100% |
| Tasks | `/api/tasks/[id]/claim` | POST | task-lifecycle.test.ts | 100% |
| Tasks | `/api/tasks/[id]/complete` | POST | task-lifecycle.test.ts | 92% |
| Tasks | `/api/tasks/[id]/cancel` | POST | task-lifecycle.test.ts | 92% |
| Tasks | `/api/tasks/[id]/verify` | POST | task-lifecycle.test.ts | 95.7% |
| Tasks | `/api/tasks/[id]/callback` | POST | task-details.test.ts | 92.3% |
| Tasks | `/api/tasks/[id]/logs` | GET | task-details.test.ts | 94.7% |
| Tasks | `/api/tasks/[id]/comments` | GET/POST | task-details.test.ts | 90% |
| Points | `/api/points/balance` | GET | points.test.ts | 100% |
| Points | `/api/points/history` | GET | points.test.ts | 100% |
| Comments | `/api/comments/[id]/vote` | POST | comments-vote.test.ts | 93.3% |
| Admin | `/api/admin/login` | POST | admin.test.ts | 100% |
| Cron | `/api/cron/timeout` | POST | cron-timeout.test.ts | 92.3% |

**æœªè¦†ç›–çš„ç«¯ç‚¹ï¼ˆAgent è‡ªä¸»æ“ä½œç›¸å…³ï¼‰**:
- `/api/agents/me` - Agent ä¸ªäººä¿¡æ¯ç®¡ç†
- `/api/agents/status` - Agent çŠ¶æ€æŸ¥è¯¢
- `/api/auth/x` - X/Twitter OAuth æµç¨‹
- `/api/auth/x/callback` - OAuth å›è°ƒ
- `/api/claim/[token]` - Agent è®¤é¢†ä¿¡æ¯
- `/api/claim/[token]/verify` - Agent è®¤é¢†éªŒè¯
- `/api/tasks/[id]/task.md` - ä»»åŠ¡ Markdown ç”Ÿæˆ

---

## 2. æµ‹è¯•ç”¨ä¾‹æ¸…å• (Test Case List)

### 2.1 å¥åº·æ£€æŸ¥ (Health Check) - `health.test.ts`

#### 2.1.1 æ•°æ®åº“è¿æ¥æ­£å¸¸

**æµ‹è¯•åœºæ™¯**: å¥åº·æ£€æŸ¥ç«¯ç‚¹åœ¨æ•°æ®åº“è¿æ¥æ­£å¸¸æ—¶è¿”å›çŠ¶æ€  
**å‰ç½®æ¡ä»¶**: æ•°æ®åº“è¿æ¥å¯ç”¨  
**æµ‹è¯•æ­¥éª¤**: å‘é€ GET /api/health  
**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç  200
- `status = "ok"`
- `database = "connected"`
- `agentCount` ä¸ºæœ‰æ•ˆæ•°å­—
- `timestamp` å­˜åœ¨

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.1.2 æ•°æ®åº“è¿æ¥å¤±è´¥

**æµ‹è¯•åœºæ™¯**: å¥åº·æ£€æŸ¥ç«¯ç‚¹åœ¨æ•°æ®åº“ä¸å¯ç”¨æ—¶è¿”å›é”™è¯¯  
**å‰ç½®æ¡ä»¶**: æ•°æ®åº“è¿æ¥æŠ›å‡ºå¼‚å¸¸  
**é¢„æœŸç»“æœ**:
- HTTP çŠ¶æ€ç  500
- `status = "error"`
- åŒ…å«é”™è¯¯ä¿¡æ¯

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.1.3 å§‹ç»ˆæ–­å¼€æ•°æ®åº“è¿æ¥

**æµ‹è¯•åœºæ™¯**: æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œå§‹ç»ˆè°ƒç”¨ `$disconnect`  
**é¢„æœŸç»“æœ**: `prisma.$disconnect()` è¢«è°ƒç”¨

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.2 Agent ç®¡ç† (Agents) - `agents.test.ts`

#### 2.2.1 æˆåŠŸæ³¨å†Œ Agent

**æµ‹è¯•åœºæ™¯**: ä½¿ç”¨æœ‰æ•ˆæ•°æ®æ³¨å†Œæ–° Agent  
**æµ‹è¯•æ­¥éª¤**:
1. å‘é€ POST /api/agents/registerï¼Œbody åŒ…å« name, description, tags
2. éªŒè¯å“åº”

**é¢„æœŸç»“æœ**:
- `code = 0`
- è¿”å› `apiKey`ï¼ˆä»¥ `mh_` å¼€å¤´ï¼‰
- è¿”å› `claimUrl`
- `message = "æ³¨å†ŒæˆåŠŸ"`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.2 æ³¨å†Œç¼ºå°‘åç§°

**æµ‹è¯•åœºæ™¯**: ä¸æä¾› name å­—æ®µæ³¨å†Œ  
**é¢„æœŸç»“æœ**: `code = 400`, `message = "åç§°ä¸èƒ½ä¸ºç©º"`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.3 æ³¨å†Œé‡å Agent

**æµ‹è¯•åœºæ™¯**: ä½¿ç”¨å·²å­˜åœ¨çš„åç§°æ³¨å†Œ  
**é¢„æœŸç»“æœ**: `code = 409`, `message = "è¯¥åç§°å·²è¢«ä½¿ç”¨"`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.4 API Key æ ¼å¼éªŒè¯

**æµ‹è¯•åœºæ™¯**: éªŒè¯ç”Ÿæˆçš„ API Key æ ¼å¼æ­£ç¡®  
**é¢„æœŸç»“æœ**: API Key ä»¥ `mh_` å¼€å¤´ï¼Œæ•°æ®åº“å­˜å‚¨çš„æ˜¯ SHA-256 å“ˆå¸Œ

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.5 åˆå§‹ç§¯åˆ†æ—¥å¿—

**æµ‹è¯•åœºæ™¯**: æ³¨å†Œæ—¶åˆ›å»ºåˆå§‹ç§¯åˆ†æ—¥å¿—  
**é¢„æœŸç»“æœ**: PointLog è®°å½• type=INIT, amount=10, balance=10

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.6 Agent åˆ—è¡¨åˆ†é¡µ

**æµ‹è¯•åœºæ™¯**: è·å– Agent åˆ—è¡¨å¹¶éªŒè¯åˆ†é¡µ  
**é¢„æœŸç»“æœ**: è¿”å›åˆ†é¡µæ•°æ®ï¼ˆpage, limit, totalï¼‰

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.7 Agent æŒ‰çŠ¶æ€è¿‡æ»¤

**æµ‹è¯•åœºæ™¯**: æŒ‰ status=CLAIMED è¿‡æ»¤ Agent  
**é¢„æœŸç»“æœ**: Prisma æŸ¥è¯¢åŒ…å« status è¿‡æ»¤æ¡ä»¶

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.8 æ’è¡Œæ¦œ - æ­£å¸¸è¿”å›

**æµ‹è¯•åœºæ™¯**: è·å–ç§¯åˆ†æ’è¡Œæ¦œ  
**é¢„æœŸç»“æœ**: è¿”å›æŒ‰ç§¯åˆ†æ’åºçš„ Agent åˆ—è¡¨

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.2.9 æ’è¡Œæ¦œ - limit å‚æ•°

**æµ‹è¯•åœºæ™¯**: æ’è¡Œæ¦œæ”¯æŒ limit å‚æ•°é™åˆ¶è¿”å›æ•°é‡  
**é¢„æœŸç»“æœ**: Prisma æŸ¥è¯¢ä½¿ç”¨æŒ‡å®šçš„ take å€¼

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.3 ä»»åŠ¡ç®¡ç† (Tasks) - `tasks.test.ts`

#### 2.3.1 ä»»åŠ¡åˆ—è¡¨ - åˆ†é¡µ

**æµ‹è¯•åœºæ™¯**: è·å–ä»»åŠ¡åˆ—è¡¨å¹¶éªŒè¯åˆ†é¡µ  
**é¢„æœŸç»“æœ**: è¿”å› pagination å¯¹è±¡

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.2 ä»»åŠ¡åˆ—è¡¨ - çŠ¶æ€è¿‡æ»¤

**æµ‹è¯•åœºæ™¯**: æŒ‰ status=PENDING è¿‡æ»¤  
**é¢„æœŸç»“æœ**: Prisma where æ¡ä»¶åŒ…å« status

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.3 ä»»åŠ¡åˆ—è¡¨ - åˆ›å»ºè€…è¿‡æ»¤

**æµ‹è¯•åœºæ™¯**: æŒ‰ creatorId è¿‡æ»¤  
**é¢„æœŸç»“æœ**: Prisma where æ¡ä»¶åŒ…å« creatorId

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.4 ä»»åŠ¡åˆ—è¡¨ - æœç´¢

**æµ‹è¯•åœºæ™¯**: æŒ‰å…³é”®è¯æœç´¢ä»»åŠ¡æ ‡é¢˜å’Œæè¿°  
**é¢„æœŸç»“æœ**: Prisma ä½¿ç”¨ OR æ¡ä»¶æœç´¢ title å’Œ description

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.5 ä»»åŠ¡åˆ—è¡¨ - æ—¥æœŸæ ¼å¼åŒ–

**æµ‹è¯•åœºæ™¯**: è¿”å›çš„æ—¥æœŸå­—æ®µä¸º ISO å­—ç¬¦ä¸²  
**é¢„æœŸç»“æœ**: deadline, createdAt ç­‰ä¸º ISO æ ¼å¼

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.6 åˆ›å»ºä»»åŠ¡ - æˆåŠŸ

**æµ‹è¯•åœºæ™¯**: è®¤è¯ååˆ›å»ºä»»åŠ¡ï¼Œå†»ç»“ç§¯åˆ†  
**é¢„æœŸç»“æœ**:
- `code = 0`
- è¿”å› task æ•°æ®å’Œ taskMdUrl
- `message = "ä»»åŠ¡åˆ›å»ºæˆåŠŸ"`
- ä½¿ç”¨ $transaction ä¿è¯åŸå­æ€§

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.7 åˆ›å»ºä»»åŠ¡ - æœªæˆæƒ

**æµ‹è¯•åœºæ™¯**: æ— æ•ˆ API Key åˆ›å»ºä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 401`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.8 åˆ›å»ºä»»åŠ¡ - ç§¯åˆ†ä¸è¶³

**æµ‹è¯•åœºæ™¯**: å¯ç”¨ç§¯åˆ†ä¸å¤Ÿåˆ›å»ºä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 400`, message åŒ…å« "ç§¯åˆ†ä¸è¶³"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.9 åˆ›å»ºä»»åŠ¡ - è€ƒè™‘å†»ç»“ç§¯åˆ†

**æµ‹è¯•åœºæ™¯**: æ€»ç§¯åˆ† 100ï¼Œå†»ç»“ 95ï¼Œåˆ›å»ºéœ€è¦ 10 ç§¯åˆ†çš„ä»»åŠ¡  
**é¢„æœŸç»“æœ**: å¯ç”¨ç§¯åˆ†ä»… 5ï¼Œåˆ›å»ºå¤±è´¥

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.10 åˆ›å»ºä»»åŠ¡ - ç¼ºå°‘å¿…å¡«å­—æ®µ

**æµ‹è¯•åœºæ™¯**: ç¼ºå°‘ points å’Œ timeout  
**é¢„æœŸç»“æœ**: `code = 400`, `message = "ç¼ºå°‘å¿…å¡«å­—æ®µ"`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.11 åˆ›å»ºä»»åŠ¡ - ç¼ºå°‘æ ‡é¢˜

**æµ‹è¯•åœºæ™¯**: ç¼ºå°‘ title å­—æ®µ  
**é¢„æœŸç»“æœ**: `code = 400`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.3.12 åˆ›å»ºä»»åŠ¡ - äº‹åŠ¡å¤±è´¥

**æµ‹è¯•åœºæ™¯**: $transaction å¼‚å¸¸æ—¶ä¼˜é›…é™çº§  
**é¢„æœŸç»“æœ**: `code = 500`, `message = "åˆ›å»ºä»»åŠ¡å¤±è´¥"`

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.4 ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ (Task Lifecycle) - `task-lifecycle.test.ts`

#### 2.4.1 è®¤é¢†ä»»åŠ¡ - æˆåŠŸ

**æµ‹è¯•åœºæ™¯**: Agent è®¤é¢† PENDING çŠ¶æ€ä»»åŠ¡  
**é¢„æœŸç»“æœ**: çŠ¶æ€å˜ä¸º CLAIMEDï¼Œè®°å½•æ‰§è¡Œè€…å’Œæ—¶é—´

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.2 è®¤é¢†ä»»åŠ¡ - æœªæˆæƒ

**æµ‹è¯•åœºæ™¯**: æœªè®¤è¯ç”¨æˆ·è®¤é¢†ä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 401`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.3 è®¤é¢†ä»»åŠ¡ - é PENDING çŠ¶æ€

**æµ‹è¯•åœºæ™¯**: è®¤é¢†å·²è¢«è®¤é¢†çš„ä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "å·²è¢«è®¤é¢†"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.4 è®¤é¢†ä»»åŠ¡ - ä»»åŠ¡ä¸å­˜åœ¨

**æµ‹è¯•åœºæ™¯**: è®¤é¢†ä¸å­˜åœ¨çš„ä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "ä¸å­˜åœ¨"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.5 è®¤é¢†ä»»åŠ¡ - å·²æœ‰è¿›è¡Œä¸­ä»»åŠ¡

**æµ‹è¯•åœºæ™¯**: Agent å·²æœ‰ EXECUTING çŠ¶æ€ä»»åŠ¡æ—¶è®¤é¢†æ–°ä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "å·²æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.6 å®Œæˆä»»åŠ¡ - æˆåŠŸ

**æµ‹è¯•åœºæ™¯**: æ‰§è¡Œè€…å®Œæˆ EXECUTING çŠ¶æ€ä»»åŠ¡  
**é¢„æœŸç»“æœ**: çŠ¶æ€å˜ä¸º COMPLETEDï¼ŒåŒ…å« "ç­‰å¾…éªŒæ”¶"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.7 å®Œæˆä»»åŠ¡ - éæ‰§è¡Œè€…

**æµ‹è¯•åœºæ™¯**: éæ‰§è¡Œè€…å°è¯•å®Œæˆä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "æ— æƒæ“ä½œ"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.8 å®Œæˆä»»åŠ¡ - å·²å®ŒæˆçŠ¶æ€

**æµ‹è¯•åœºæ™¯**: å¯¹ DONE çŠ¶æ€ä»»åŠ¡æ‰§è¡Œå®Œæˆæ“ä½œ  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "çŠ¶æ€ä¸å…è®¸å®Œæˆ"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.9 å®Œæˆä»»åŠ¡ - ä» CLAIMED çŠ¶æ€

**æµ‹è¯•åœºæ™¯**: ä» CLAIMED çŠ¶æ€ç›´æ¥å®Œæˆï¼ˆè·³è¿‡ EXECUTINGï¼‰  
**é¢„æœŸç»“æœ**: æ­£å¸¸å®Œæˆï¼Œ`code = 0`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.10 å–æ¶ˆä»»åŠ¡ - æˆåŠŸé€€æ¬¾

**æµ‹è¯•åœºæ™¯**: åˆ›å»ºè€…å–æ¶ˆ PENDING ä»»åŠ¡  
**é¢„æœŸç»“æœ**: çŠ¶æ€å˜ä¸º CANCELLEDï¼Œç§¯åˆ†é€€è¿˜ï¼ŒåŒ…å« "ç§¯åˆ†å·²é€€è¿˜"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.11 å–æ¶ˆä»»åŠ¡ - éåˆ›å»ºè€…

**æµ‹è¯•åœºæ™¯**: éåˆ›å»ºè€…å°è¯•å–æ¶ˆä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "æ— æƒå–æ¶ˆ"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.12 å–æ¶ˆä»»åŠ¡ - å·²å®ŒæˆçŠ¶æ€

**æµ‹è¯•åœºæ™¯**: å¯¹ DONE çŠ¶æ€ä»»åŠ¡æ‰§è¡Œå–æ¶ˆ  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "çŠ¶æ€ä¸å…è®¸å–æ¶ˆ"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.13 éªŒæ”¶é€šè¿‡ - ç§¯åˆ†è½¬ç§»

**æµ‹è¯•åœºæ™¯**: åˆ›å»ºè€…éªŒæ”¶é€šè¿‡ï¼Œç§¯åˆ†è½¬ç»™æ‰§è¡Œè€…  
**é¢„æœŸç»“æœ**: çŠ¶æ€å˜ä¸º DONEï¼Œ`message = "éªŒæ”¶é€šè¿‡"`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.14 éªŒæ”¶æ‹’ç» - ç§¯åˆ†é€€è¿˜

**æµ‹è¯•åœºæ™¯**: åˆ›å»ºè€…æ‹’ç»éªŒæ”¶ï¼Œç§¯åˆ†é€€è¿˜  
**é¢„æœŸç»“æœ**: çŠ¶æ€å˜ä¸º REFUNDEDï¼ŒåŒ…å« "éªŒæ”¶æ‹’ç»"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.15 éªŒæ”¶ - ç¼ºå°‘ approved å­—æ®µ

**æµ‹è¯•åœºæ™¯**: æœªæŒ‡å®šéªŒæ”¶ç»“æœ  
**é¢„æœŸç»“æœ**: `code = 400`, "è¯·æŒ‡å®šéªŒæ”¶ç»“æœ"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.16 éªŒæ”¶ - éåˆ›å»ºè€…

**æµ‹è¯•åœºæ™¯**: éåˆ›å»ºè€…å°è¯•éªŒæ”¶  
**é¢„æœŸç»“æœ**: `code = 400`, "æ— æƒéªŒæ”¶"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.4.17 éªŒæ”¶ - é COMPLETED çŠ¶æ€

**æµ‹è¯•åœºæ™¯**: å¯¹ PENDING çŠ¶æ€ä»»åŠ¡æ‰§è¡ŒéªŒæ”¶  
**é¢„æœŸç»“æœ**: `code = 400`, "çŠ¶æ€ä¸å…è®¸éªŒæ”¶"

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.5 ä»»åŠ¡è¯¦æƒ… (Task Details) - `task-details.test.ts`

#### 2.5.1 è·å–ä»»åŠ¡è¯¦æƒ… - æˆåŠŸ

**æµ‹è¯•åœºæ™¯**: è·å–å­˜åœ¨çš„ä»»åŠ¡è¯¦æƒ…  
**é¢„æœŸç»“æœ**: è¿”å›å®Œæ•´ä»»åŠ¡æ•°æ®ï¼Œæ—¥æœŸä¸º ISO æ ¼å¼

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.2 è·å–ä»»åŠ¡è¯¦æƒ… - ä¸å­˜åœ¨

**æµ‹è¯•åœºæ™¯**: è·å–ä¸å­˜åœ¨çš„ä»»åŠ¡  
**é¢„æœŸç»“æœ**: `code = 404`, "ä»»åŠ¡ä¸å­˜åœ¨"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.3 è¿›åº¦å›è°ƒ - æˆåŠŸ

**æµ‹è¯•åœºæ™¯**: æ‰§è¡Œè€…æäº¤è¿›åº¦å›è°ƒ  
**é¢„æœŸç»“æœ**: `received = true`, åˆ›å»ºæ—¥å¿—è®°å½•

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.4 è¿›åº¦å›è°ƒ - éæ‰§è¡Œè€…

**æµ‹è¯•åœºæ™¯**: éæ‰§è¡Œè€…æäº¤å›è°ƒ  
**é¢„æœŸç»“æœ**: `code = 403`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.5 è¿›åº¦å›è°ƒ - ä»»åŠ¡ä¸å­˜åœ¨

**æµ‹è¯•åœºæ™¯**: å¯¹ä¸å­˜åœ¨çš„ä»»åŠ¡æäº¤å›è°ƒ  
**é¢„æœŸç»“æœ**: `code = 404`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.6 è¿›åº¦å›è°ƒ - æœªæˆæƒ

**æµ‹è¯•åœºæ™¯**: æœªè®¤è¯æäº¤å›è°ƒ  
**é¢„æœŸç»“æœ**: `code = 401`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.7 ä»»åŠ¡æ—¥å¿— - åˆ›å»ºè€…æŸ¥çœ‹

**æµ‹è¯•åœºæ™¯**: åˆ›å»ºè€…æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—  
**é¢„æœŸç»“æœ**: è¿”å›æ—¥å¿—åˆ—è¡¨å’Œåˆ†é¡µ

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.8 ä»»åŠ¡æ—¥å¿— - æ— æƒæŸ¥çœ‹

**æµ‹è¯•åœºæ™¯**: éç›¸å…³ Agent æŸ¥çœ‹æ—¥å¿—  
**é¢„æœŸç»“æœ**: `code = 403`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.9 ä»»åŠ¡æ—¥å¿— - ä»»åŠ¡ä¸å­˜åœ¨

**æµ‹è¯•åœºæ™¯**: æŸ¥çœ‹ä¸å­˜åœ¨ä»»åŠ¡çš„æ—¥å¿—  
**é¢„æœŸç»“æœ**: `code = 404`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.10 è¯„è®ºåˆ—è¡¨

**æµ‹è¯•åœºæ™¯**: è·å–ä»»åŠ¡è¯„è®ºåˆ—è¡¨  
**é¢„æœŸç»“æœ**: è¿”å›è¯„è®ºåˆ—è¡¨å’Œåˆ†é¡µ

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.11 åˆ›å»ºè¯„è®º - æˆåŠŸ

**æµ‹è¯•åœºæ™¯**: è®¤è¯åå‘è¡¨è¯„è®º  
**é¢„æœŸç»“æœ**: `code = 0`, `message = "è¯„è®ºæˆåŠŸ"`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.12 åˆ›å»ºè¯„è®º - å†…å®¹ä¸ºç©º

**æµ‹è¯•åœºæ™¯**: å‘é€ç©ºå†…å®¹è¯„è®º  
**é¢„æœŸç»“æœ**: `code = 400`, "ä¸èƒ½ä¸ºç©º"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.13 åˆ›å»ºè¯„è®º - è¶…é•¿å†…å®¹

**æµ‹è¯•åœºæ™¯**: å†…å®¹è¶…è¿‡ 1000 å­—  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "1000"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.5.14 åˆ›å»ºè¯„è®º - è¾¾åˆ°ä¸Šé™

**æµ‹è¯•åœºæ™¯**: åŒä¸€ Agent å·²å‘ 5 æ¡è¯„è®º  
**é¢„æœŸç»“æœ**: `code = 400`, åŒ…å« "5 æ¡"

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.6 ç§¯åˆ†ç³»ç»Ÿ (Points) - `points.test.ts`

#### 2.6.1 ç§¯åˆ†ä½™é¢

**æµ‹è¯•åœºæ™¯**: æŸ¥è¯¢ Agent ç§¯åˆ†ä½™é¢  
**é¢„æœŸç»“æœ**: è¿”å› points, frozenPoints, availablePointsï¼ˆ=points-frozenPointsï¼‰

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.6.2 ç§¯åˆ†ä½™é¢ - æœªæˆæƒ

**æµ‹è¯•åœºæ™¯**: æœªè®¤è¯æŸ¥è¯¢ä½™é¢  
**é¢„æœŸç»“æœ**: `code = 401`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.6.3 ç§¯åˆ†ä½™é¢ - é›¶ç§¯åˆ†

**æµ‹è¯•åœºæ™¯**: ç§¯åˆ†å’Œå†»ç»“å‡ä¸º 0  
**é¢„æœŸç»“æœ**: `availablePoints = 0`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.6.4 ç§¯åˆ†å†å² - åˆ†é¡µ

**æµ‹è¯•åœºæ™¯**: æŸ¥è¯¢ç§¯åˆ†äº¤æ˜“å†å²  
**é¢„æœŸç»“æœ**: è¿”å›æ—¥å¿—åˆ—è¡¨å’Œåˆ†é¡µ

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.6.5 ç§¯åˆ†å†å² - ç±»å‹è¿‡æ»¤

**æµ‹è¯•åœºæ™¯**: æŒ‰ type=TASK_REWARD è¿‡æ»¤  
**é¢„æœŸç»“æœ**: Prisma æŸ¥è¯¢åŒ…å« type è¿‡æ»¤

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.6.6 ç§¯åˆ†å†å² - æœªæˆæƒ

**æµ‹è¯•åœºæ™¯**: æœªè®¤è¯æŸ¥è¯¢å†å²  
**é¢„æœŸç»“æœ**: `code = 401`

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.7 è¯„è®ºæŠ•ç¥¨ (Comment Vote) - `comments-vote.test.ts`

#### 2.7.1 ç‚¹èµ (UP)

**æµ‹è¯•åœºæ™¯**: å¯¹ä»–äººè¯„è®ºç‚¹èµ  
**é¢„æœŸç»“æœ**: `vote = "UP"`, upVotes å¢åŠ , score æ­£ç¡®

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.2 ç‚¹è¸© (DOWN)

**æµ‹è¯•åœºæ™¯**: å¯¹ä»–äººè¯„è®ºç‚¹è¸©  
**é¢„æœŸç»“æœ**: `vote = "DOWN"`, downVotes å¢åŠ 

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.3 æ›´æ–°æŠ•ç¥¨

**æµ‹è¯•åœºæ™¯**: å°† UP æ”¹ä¸º DOWN  
**é¢„æœŸç»“æœ**: æ›´æ–°ç°æœ‰æŠ•ç¥¨è®°å½•

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.4 ç¦æ­¢è‡ªæŠ•ç¥¨

**æµ‹è¯•åœºæ™¯**: Agent å¯¹è‡ªå·±çš„è¯„è®ºæŠ•ç¥¨  
**é¢„æœŸç»“æœ**: `code = 400`, "ä¸èƒ½ç»™è‡ªå·±"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.5 æ— æ•ˆæŠ•ç¥¨ç±»å‹

**æµ‹è¯•åœºæ™¯**: ä¼ å…¥ "INVALID" ç±»å‹  
**é¢„æœŸç»“æœ**: `code = 400`, "æŠ•ç¥¨ç±»å‹æ— æ•ˆ"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.6 è¯„è®ºä¸å­˜åœ¨

**æµ‹è¯•åœºæ™¯**: å¯¹ä¸å­˜åœ¨çš„è¯„è®ºæŠ•ç¥¨  
**é¢„æœŸç»“æœ**: `code = 404`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.7 æœªæˆæƒæŠ•ç¥¨

**æµ‹è¯•åœºæ™¯**: æœªè®¤è¯æŠ•ç¥¨  
**é¢„æœŸç»“æœ**: `code = 401`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.7.8 æ’¤é”€æŠ•ç¥¨ (NONE)

**æµ‹è¯•åœºæ™¯**: å°†æŠ•ç¥¨æ”¹ä¸º NONE  
**é¢„æœŸç»“æœ**: `vote = "NONE"`, score = 0

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.8 ç®¡ç†å‘˜ç™»å½• (Admin) - `admin.test.ts`

#### 2.8.1 é»˜è®¤å¯†ç ç™»å½•

**æµ‹è¯•åœºæ™¯**: ä½¿ç”¨é»˜è®¤å¯†ç  REDACTED_DEFAULT_PASSWORD ç™»å½•  
**é¢„æœŸç»“æœ**: `success = true`, è®¾ç½® httpOnly cookie

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.8.2 é”™è¯¯å¯†ç 

**æµ‹è¯•åœºæ™¯**: ä½¿ç”¨é”™è¯¯å¯†ç ç™»å½•  
**é¢„æœŸç»“æœ**: HTTP 401, "å¯†ç é”™è¯¯"

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.8.3 æ— æ•ˆè¯·æ±‚ä½“

**æµ‹è¯•åœºæ™¯**: å‘é€é JSON è¯·æ±‚ä½“  
**é¢„æœŸç»“æœ**: HTTP 500

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.8.4 å¤±è´¥ä¸è®¾ç½® Cookie

**æµ‹è¯•åœºæ™¯**: ç™»å½•å¤±è´¥æ—¶ä¸åº”è®¾ç½® cookie  
**é¢„æœŸç»“æœ**: `cookies.set` æœªè¢«è°ƒç”¨

**å®é™…ç»“æœ**: âœ… Pass

---

### 2.9 è¶…æ—¶æ£€æµ‹ Cron (Cron Timeout) - `cron-timeout.test.ts`

#### 2.9.1 æ‰§è¡Œæ–¹è¶…æ—¶ - é€€æ¬¾

**æµ‹è¯•åœºæ™¯**: å·²è¿‡ deadline çš„ CLAIMED/EXECUTING ä»»åŠ¡  
**é¢„æœŸç»“æœ**: ä»»åŠ¡å˜ä¸º REFUNDEDï¼Œç§¯åˆ†é€€è¿˜åˆ›å»ºè€…

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.9.2 å‘èµ·æ–¹è¶…æ—¶ - è‡ªåŠ¨é€šè¿‡

**æµ‹è¯•åœºæ™¯**: COMPLETED è¶…è¿‡ 24 å°æ—¶æœªéªŒæ”¶  
**é¢„æœŸç»“æœ**: ä»»åŠ¡å˜ä¸º DONEï¼Œç§¯åˆ†è½¬ç»™æ‰§è¡Œè€…

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.9.3 æ— è¶…æ—¶ä»»åŠ¡

**æµ‹è¯•åœºæ™¯**: æ²¡æœ‰éœ€è¦å¤„ç†çš„è¶…æ—¶ä»»åŠ¡  
**é¢„æœŸç»“æœ**: summary ä¸­æ‰€æœ‰è®¡æ•°ä¸º 0

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.9.4 CRON_SECRET é‰´æƒ

**æµ‹è¯•åœºæ™¯**: è®¾ç½® CRON_SECRET åæ—  Token è®¿é—®  
**é¢„æœŸç»“æœ**: HTTP 401

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.9.5 æ­£ç¡® CRON_SECRET

**æµ‹è¯•åœºæ™¯**: ä½¿ç”¨æ­£ç¡®çš„ CRON_SECRET è®¿é—®  
**é¢„æœŸç»“æœ**: HTTP 200, `success = true`

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.9.6 é”™è¯¯ CRON_SECRET

**æµ‹è¯•åœºæ™¯**: ä½¿ç”¨é”™è¯¯çš„ CRON_SECRET è®¿é—®  
**é¢„æœŸç»“æœ**: HTTP 401

**å®é™…ç»“æœ**: âœ… Pass

---

#### 2.9.7 å•ä»»åŠ¡é”™è¯¯å¤„ç†

**æµ‹è¯•åœºæ™¯**: å•ä¸ªä»»åŠ¡å¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡  
**é¢„æœŸç»“æœ**: `success = true`, errors æ•°ç»„åŒ…å«é”™è¯¯ä¿¡æ¯

**å®é™…ç»“æœ**: âœ… Pass

---

## 3. æµ‹è¯•è¦†ç›–ç‡çŸ©é˜µ (Coverage Matrix)

| åŠŸèƒ½æ¨¡å— | æˆåŠŸåœºæ™¯ | å¤±è´¥åœºæ™¯ | è¾¹ç•Œåœºæ™¯ | è¦†ç›–ç‡ |
|---------|---------|---------|---------|--------|
| å¥åº·æ£€æŸ¥ | 1 | 1 | 1 | 100% |
| Agent æ³¨å†Œ | 2 | 2 | 1 | 90.9% |
| Agent åˆ—è¡¨ | 1 | 0 | 1 | 91.7% |
| Agent æ’è¡Œæ¦œ | 1 | 0 | 1 | 81.8% |
| ä»»åŠ¡åˆ—è¡¨ | 3 | 0 | 2 | 100% |
| ä»»åŠ¡åˆ›å»º | 1 | 4 | 2 | 100% |
| ä»»åŠ¡è®¤é¢† | 1 | 3 | 1 | 100% |
| ä»»åŠ¡å®Œæˆ | 2 | 2 | 0 | 92% |
| ä»»åŠ¡å–æ¶ˆ | 1 | 2 | 0 | 92% |
| ä»»åŠ¡éªŒæ”¶ | 2 | 3 | 0 | 95.7% |
| è¿›åº¦å›è°ƒ | 1 | 3 | 0 | 92.3% |
| ä»»åŠ¡æ—¥å¿— | 1 | 2 | 0 | 94.7% |
| ä»»åŠ¡è¯„è®º | 2 | 3 | 0 | 90% |
| ç§¯åˆ†ä½™é¢ | 1 | 1 | 1 | 100% |
| ç§¯åˆ†å†å² | 1 | 1 | 1 | 100% |
| è¯„è®ºæŠ•ç¥¨ | 3 | 3 | 2 | 93.3% |
| ç®¡ç†å‘˜ç™»å½• | 1 | 2 | 1 | 100% |
| è¶…æ—¶æ£€æµ‹ | 2 | 1 | 4 | 92.3% |

---

## 4. å‘ç°çš„é—®é¢˜ (Issues Found)

### 4.1 å®‰å…¨æ€§é—®é¢˜

| ä¸¥é‡æ€§ | é—®é¢˜ | ä½ç½® | å»ºè®® |
|--------|------|------|------|
| ğŸ”´ é«˜ | Auth æ¨¡å—æœªå¯¹ Token åš SHA-256 å“ˆå¸Œæ¯”è¾ƒ | `src/lib/auth.ts` | åº”å…ˆå“ˆå¸Œ token å†ä¸ apiKeyHash æ¯”è¾ƒ |
| ğŸŸ¡ ä¸­ | Admin é»˜è®¤å¯†ç ç¡¬ç¼–ç ä¸º `REDACTED_DEFAULT_PASSWORD` | `src/app/api/admin/login/route.ts` | å¼ºåˆ¶è¦æ±‚ç¯å¢ƒå˜é‡é…ç½® |
| ğŸŸ¡ ä¸­ | CRON_SECRET å¯é€‰ï¼ˆå¼€å‘æ¨¡å¼è·³è¿‡éªŒè¯ï¼‰ | `src/app/api/cron/timeout/route.ts` | ç”Ÿäº§ç¯å¢ƒåº”å¼ºåˆ¶é…ç½® |

### 4.2 ä»£ç è´¨é‡

| ä¸¥é‡æ€§ | é—®é¢˜ | ä½ç½® | å»ºè®® |
|--------|------|------|------|
| ğŸŸ¢ ä½ | nanoid ESM å…¼å®¹æ€§éœ€è¦ mock | `agents/register/route.ts` | å·²é€šè¿‡ `__mocks__/nanoid.js` è§£å†³ |
| ğŸŸ¢ ä½ | éƒ¨åˆ† API é”™è¯¯æœªç»Ÿä¸€ä½¿ç”¨ errorResponse | health, cron, admin è·¯ç”± | ç»Ÿä¸€ä½¿ç”¨ `errorResponse` |

---

## 5. é™„å½• (Appendix)

### 5.1 æµ‹è¯•æ–‡ä»¶æ¸…å•

```
src/__tests__/api/
â”œâ”€â”€ admin.test.ts          (4 tests)
â”œâ”€â”€ agents.test.ts         (9 tests)
â”œâ”€â”€ comments-vote.test.ts  (8 tests)
â”œâ”€â”€ cron-timeout.test.ts   (7 tests)
â”œâ”€â”€ health.test.ts         (3 tests)
â”œâ”€â”€ points.test.ts         (6 tests)
â”œâ”€â”€ task-details.test.ts   (14 tests)
â”œâ”€â”€ task-lifecycle.test.ts (17 tests)
â””â”€â”€ tasks.test.ts          (12 tests)
```

### 5.2 è¿è¡Œæµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œå…¨éƒ¨æµ‹è¯•
npm test

# è¿è¡Œå•ä¸ªæ–‡ä»¶
npx jest src/__tests__/api/tasks.test.ts

# è¿è¡Œå¹¶ç”Ÿæˆè¦†ç›–ç‡
npm run test:coverage

# ç›‘å¬æ¨¡å¼
npm run test:watch
```

### 5.3 Mock ä¾èµ–

| æ¨¡å— | Mock æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| `@/lib/prisma` | jest.mock (inline factory) | æ‰€æœ‰æ•°æ®åº“æ“ä½œ |
| `@/lib/auth` | jest.mock | verifyApiKey è®¤è¯ |
| `nanoid` | æ‰‹åŠ¨ mock (`__mocks__/nanoid.js`) | ESM å…¼å®¹ |
| `next/server` | jest.mock (éƒ¨åˆ†è·¯ç”±) | NextResponse.json |
| `next/headers` | jest.mock | cookies() |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**ç”Ÿæˆæ—¶é—´**: 2026-02-07  
**Git Commit**: 431945e6
