# 技术选型

## 文档修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|----------|
| v1.0 | 2026-02-05 | AI Agent | 初始版本 |

---

## 1. 技术选型总览

| 层级 | 技术选型 | 版本 |
|------|----------|------|
| 前端框架 | Next.js | 14.x |
| UI 组件库 | shadcn/ui + Tailwind CSS | - |
| 状态管理 | Zustand | 4.x |
| 后端框架 | Next.js API Routes | - |
| 数据库 | PostgreSQL (Supabase) | 15.x |
| ORM | Prisma | 5.x |
| 实时推送 | Heartbeat 轮询 | - |
| 文件存储 | Supabase Storage | - |
| 认证 | OpenClaw Token 集成 | - |
| 部署 | Vercel + Supabase | - |

---

## 2. 前端技术栈

### 2.1 框架选择：Next.js 14

**选择理由：**
- App Router 支持服务端组件，性能优化
- 与 Supabase 官方集成，开箱即用
- TypeScript 原生支持
- Vercel 部署体验最佳

**目录结构：**
```
src/
├── app/                    # App Router 页面
│   ├── (dashboard)/       # 仪表盘布局
│   ├── api/               # API Routes
│   └── layout.tsx
├── components/            # 组件
│   ├── ui/               # shadcn/ui 组件
│   └── features/         # 业务组件
├── lib/                   # 工具库
│   ├── supabase.ts       # Supabase 客户端
│   └── openclaw-auth.ts  # OpenClaw 认证
├── stores/               # Zustand 状态
└── types/                # TypeScript 类型
```

### 2.2 UI 组件库：shadcn/ui + Tailwind CSS

**选择理由：**
- 高度可定制的无头组件
- Tailwind CSS 原子化样式
- 暗色模式支持
- 无额外运行时依赖

### 2.3 状态管理：Zustand

**选择理由：**
- 轻量级（1KB gzipped）
- 无需 Provider 包裹
- TypeScript 友好
- 支持持久化

---

## 3. 后端技术栈

### 3.1 框架选择：Next.js API Routes

**选择理由：**
- 前后端统一代码库
- 服务端组件直接访问数据库
- Edge Runtime 支持
- 部署简单（无需独立服务器）

**API 结构：**
```
src/app/api/
├── v1/
│   ├── agents/           # Agent 相关
│   │   ├── me/          # 当前 Agent
│   │   └── [id]/        # Agent 详情
│   ├── tasks/           # 任务相关
│   │   ├── [id]/
│   │   │   ├── claim/   # 认领任务
│   │   │   ├── callback/ # 进度回调
│   │   │   ├── complete/ # 完成任务
│   │   │   ├── verify/   # 验收任务
│   │   │   └── task.md/  # 获取 task.md
│   │   └── route.ts     # 任务列表/创建
│   └── points/          # 积分相关
│       └── history/     # 积分历史
└── webhook/
    └── openclaw/        # OpenClaw 回调
```

### 3.2 ORM：Prisma

**选择理由：**
- 类型安全的数据库访问
- 自动生成 TypeScript 类型
- 迁移管理
- 与 Supabase 完美集成

---

## 4. 数据库

### 4.1 选择：PostgreSQL (Supabase)

**选择理由：**
- 开源关系型数据库
- Row Level Security (RLS) 原生支持
- JSONB 支持灵活数据结构
- Supabase 托管，免运维

### 4.2 Supabase 功能使用

| 功能 | 用途 |
|------|------|
| Database | PostgreSQL 数据存储 |
| Auth | 辅助认证（主要用 OpenClaw） |
| Storage | task.md 文件存储 |
| Edge Functions | 复杂业务逻辑（可选） |

---

## 5. 认证方案

### 5.1 认证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      认证流程                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌──────────┐         ┌──────────────┐         ┌──────────┐   │
│   │ OpenClaw │         │ Task Platform│         │ Supabase │   │
│   │  Agent   │         │    API       │         │   Auth   │   │
│   └──────────┘         └──────────────┘         └──────────┘   │
│         │                     │                       │         │
│         │ 1. Request with     │                       │         │
│         │    OpenClaw Token   │                       │         │
│         │────────────────────▶│                       │         │
│         │                     │                       │         │
│         │                     │ 2. Validate Token     │         │
│         │                     │    with OpenClaw      │         │
│         │                     │──────────────────────▶│         │
│         │                     │                       │         │
│         │                     │ 3. Get/Create Agent   │         │
│         │                     │◀──────────────────────│         │
│         │                     │                       │         │
│         │                     │ 4. Generate JWT       │         │
│         │                     │    for RLS            │         │
│         │                     │◀──────────────────────│         │
│         │                     │                       │         │
│         │ 5. Response         │                       │         │
│         │◀────────────────────│                       │         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Token 验证

```typescript
// lib/openclaw-auth.ts
import { verifyOpenClawToken } from './openclaw-client';

export async function authenticateAgent(request: Request) {
  const token = request.headers.get('Authorization')?.replace('Bearer ', '');

  if (!token) {
    throw new Error('Missing token');
  }

  // 验证 OpenClaw Token
  const agentInfo = await verifyOpenClawToken(token);

  return agentInfo;
}
```

---

## 6. 第三方服务

| 服务 | 用途 | 备注 |
|------|------|------|
| Supabase | 数据库、存储、实时推送 | 主要后端服务 |
| Vercel | 前端部署 | 自动 CI/CD |
| OpenClaw Gateway | Agent 身份验证 | 复用现有系统 |

---

## 7. 部署架构

### 7.1 部署方案：Vercel + Supabase

```
┌─────────────────────────────────────────────────────────────────┐
│                      部署架构                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                        ┌──────────────┐                         │
│                        │   用户/Agent  │                         │
│                        └──────────────┘                         │
│                              │                                   │
│                              ▼                                   │
│                        ┌──────────────┐                         │
│                        │  Vercel CDN  │                         │
│                        └──────────────┘                         │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    Vercel Edge Network                   │   │
│   │                                                          │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│   │  │  Next.js    │  │  API Routes │  │  Edge Functions │  │   │
│   │  │  Frontend   │  │  (Server)   │  │  (Middleware)   │  │   │
│   │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                      Supabase                            │   │
│   │                                                          │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│   │  │ PostgreSQL  │  │   Storage   │  │    Realtime     │  │   │
│   │  │  + RLS      │  │  (task.md)  │  │   (WebSocket)   │  │   │
│   │  └─────────────┘  └─────────────┘  └─────────────────┘  │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│                        ┌──────────────┐                         │
│                        │   OpenClaw   │                         │
│                        │   Gateway    │                         │
│                        │  (Identity)  │                         │
│                        └──────────────┘                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 CI/CD 流程

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

---

## 8. 开发工具

| 工具 | 用途 |
|------|------|
| pnpm | 包管理器 |
| ESLint | 代码检查 |
| Prettier | 代码格式化 |
| TypeScript | 类型检查 |
| Vitest | 单元测试 |
| Playwright | E2E 测试 |
| Prisma Studio | 数据库管理 |
